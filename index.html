<!doctype html>
<html>
  <head>
    <title>Fin for SFDC</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* iFrame must be at least 460px wide and 100% height, fixed bottom-right. */
      /* Ref: doc guidance on sizing and positioning */
      #intercom-messenger-iframe {
        position: fixed; /* floats over page content */
        right: 0;
        bottom: 0;
        width: 460px;    /* >= 460px to render properly */
        height: 100%;
        border: 0;
        z-index: 5;      /* starts behind main UI; promoted when ACTIVE */
        display: none;   /* hidden until loaded */
      }
      /* Helpful when the iframe is active */
      #iframe-active-overlay {
        position: fixed;
        inset: 0;
        background: transparent;
        z-index: 6; /* just above iframe when needed */
        display: none;
      }
    </style>

    <script>
      const USE_IFRAME_MODE = true; // toggle to false to load Messenger directly in parent (legacy)

      function reset() {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i];
          const eqPos = cookie.indexOf("=");
          const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
          document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        window.localStorage.clear();
        window.sessionStorage.clear();
        window.location.reload();
      }

      function toggleForm() {
        const form = document.getElementById("ticketForm");
        form.classList.toggle("hidden");
      }

      function submitTicket(e) {
        e.preventDefault();
        const name = document.getElementById("ticketName").value;
        const email = document.getElementById("ticketEmail").value;
        const subject = document.getElementById("ticketSubject").value;
        const message = document.getElementById("ticketMessage").value;

        console.log({ name, email, subject, message });
        alert("Ticket submitted successfully!");

        // Example: send an Intercom event via the iframe (prefix with event_)
        if (USE_IFRAME_MODE) {
          sendEvent(`event_ticket_submitted:${subject}`);
          // Optionally send a profile update too:
          const update = { name, email, last_ticket_subject: subject };
          sendUpdate(update);
        }

        document.getElementById("ticketForm").reset();
        toggleForm();
      }

      // ---------------------------
      // iFrame privilege separation
      // ---------------------------

      // Promote/demote the iFrame via z-index when Messenger is ACTIVE/IDLE.
      // Ref: Parent listens for messages & adjusts z-index
      function handleIframeMessage(event) {
        try {
          const msg = String(event.data || "").toUpperCase();
          const frame = document.getElementById("intercom-messenger-iframe");
          const overlay = document.getElementById("iframe-active-overlay");

          if (!frame) return;

          if (msg.includes("ACTIVE")) {
            frame.style.zIndex = "1000";  // bring to foreground
            overlay.style.display = "block"; // optional: capture clicks if needed
          } else if (msg.includes("IDLE")) {
            frame.style.zIndex = "5";     // send to background
            overlay.style.display = "none";
          }
        } catch (e) {
          console.warn("Message from iframe not a string:", e);
        }
      }
      window.addEventListener("message", handleIframeMessage, false);

      // Post a raw string message to the iframe
      function postToIframe(message) {
        const frame = document.getElementById("intercom-messenger-iframe");
        if (frame && frame.contentWindow) {
          // Target '*' is acceptable since the destination is the iframe we created
          // Ref: Parent -> iFrame postMessage doesnâ€™t need explicit target when URL is set
          frame.contentWindow.postMessage(message, "*");
        }
      }

      // Convenience helpers:
      // IMPORTANT: For updates, stringify JSON before sending.
      function sendUpdate(jsonObject) {
        try {
          const msg = JSON.stringify(jsonObject);
          postToIframe(msg);
        } catch (e) {
          console.error("sendUpdate requires a JSON-serializable object", e);
        }
      }

      function sendEvent(eventName) {
        // Per guidance, prefix event names with "event_"
        const safe = String(eventName || "").replace(/^event_/, "");
        postToIframe(`event_${safe}`);
      }

      function loginUser(intercomJwtOrIdentifier) {
        // You can choose your own message contract; here we use a simple tag.
        // Typically you'd generate/set a JWT or pass an identifier the iframe page understands.
        postToIframe(`login:${intercomJwtOrIdentifier}`);
      }

      function logoutUser() {
        // Triggers the iframe to call Intercom('shutdown')
        postToIframe("shutdown");
      }

      // Initialize (or reveal) the iframe once the page loads
      function initIframe() {
        const frame = document.getElementById("intercom-messenger-iframe");
        if (!frame) return;

        // Show as soon as it loads so layout is stable
        frame.addEventListener("load", () => {
          frame.style.display = "block";
          // Start idle by default until the iframe reports ACTIVE
          frame.style.zIndex = "5";
        });
      }

      // ---------------------------
      // Legacy direct Messenger init
      // ---------------------------
      // Only load the widget script when NOT using the iframe pattern.
      function initIntercomWidgetDirect() {
        (function () {
          var w = window; var ic = w.Intercom;
          if (typeof ic === "function") {
            ic("reattach_activator"); ic("update", w.intercomSettings);
          } else {
            var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); };
            w.Intercom = i; var l = function () {
              var s = d.createElement("script"); s.type = "text/javascript"; s.async = true;
              s.src = "https://widget.intercom.io/widget/nzmi3xql";
              var x = d.getElementsByTagName("script")[0]; x.parentNode.insertBefore(s, x);
            };
            if (document.readyState === "complete") { l(); }
            else if (w.attachEvent) { w.attachEvent("onload", l); }
            else { w.addEventListener("load", l, false); }
          }
        })();
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (USE_IFRAME_MODE) {
          initIframe();
        } else {
          initIntercomWidgetDirect();
        }
      });
    </script>
  </head>

  <body
    class="p-6 flex flex-col flex-1 items-center justify-center min-h-screen bg-cover"
    style="background-image: url('https://downloads.intercomcdn.com/i/o/1051523575/8c16c6bb97ae791131ead20c/blur.jpg')"
  >
    <!-- Optional overlay while ACTIVE to avoid background clicks if desired -->
    <div id="iframe-active-overlay"></div>

    <div class="flex flex-col space-y-2 items-center">
      <div>
        <img src="https://static.intercomassets.com/assets/default-avatars/fin/128-6a5eabbb84cc2b038b2afc6698ca0a974faf7adc9ea9f0fb3c3e78ac12543bc5.png" height="50" width="50" />
      </div>
      <button class="bg-black text-white p-2 m-2 rounded hover:bg-opacity-75" onclick="reset()">Reset</button>
      <button class="bg-blue-600 text-white p-2 m-2 rounded hover:bg-opacity-75" onclick="toggleForm()">Submit Ticket</button>

      <!-- Demo controls to exercise postMessage helpers -->
      <div class="flex gap-2 mt-2">
        <button class="bg-emerald-600 text-white px-3 py-2 rounded" onclick="loginUser('demo-jwt-or-id')">Login (iframe)</button>
        <button class="bg-gray-600 text-white px-3 py-2 rounded" onclick="logoutUser()">Logout (iframe)</button>
        <button class="bg-indigo-600 text-white px-3 py-2 rounded" onclick="sendEvent('event_demo_clicked')">Send Event</button>
        <button class="bg-teal-600 text-white px-3 py-2 rounded" onclick="sendUpdate({plan:'Pro', seats:25})">Send Update</button>
      </div>
    </div>

    <!-- Hidden Ticket Form -->
    <form id="ticketForm" class="hidden bg-white shadow-md rounded-lg p-6 mt-6 w-80">
      <h2 class="text-lg font-semibold mb-4">Submit a Ticket</h2>
      <input id="ticketName" type="text" placeholder="Your Name" class="w-full border rounded p-2 mb-2" required />
      <input id="ticketEmail" type="email" placeholder="Your Email" class="w-full border rounded p-2 mb-2" required />
      <input id="ticketSubject" type="text" placeholder="Subject" class="w-full border rounded p-2 mb-2" required />
      <textarea id="ticketMessage" placeholder="Message" class="w-full border rounded p-2 mb-4" rows="3" required></textarea>
      <div class="flex justify-between">
        <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" onclick="submitTicket(event)">Submit</button>
        <button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" onclick="toggleForm()">Cancel</button>
      </div>
    </form>

    <!-- Privilege-Separated Messenger iFrame -->
    <!-- IMPORTANT: host this file on a DIFFERENT domain than the parent for true separation -->
    <!-- Ref: separate domains requirement -->
    <iframe
      id="intercom-messenger-iframe"
      src="https://www.mymessenger.com/messenger_iframe.html"
      title="Intercom Messenger"
      frameborder="0"
      sandbox="allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-downloads allow-top-navigation-by-user-activation"
      aria-hidden="true"
    ></iframe>

    <!-- Direct Intercom config (only used when USE_IFRAME_MODE=false) -->
    <script>
      if (!USE_IFRAME_MODE) {
        window.intercomSettings = {
          api_base: "https://api-iam.intercom.io",
          app_id: "nzmi3xql",
          intercom_user_jwt:
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiYXhhODY0IiwiZW1haWwiOiJsdWlzQG1kbHNvbHV0aW9ucy5uZXQiLCJuYW1lIjoiVGVzcyBTdWxsaXZhbiIsImlhdCI6MTc1ODAwNzAzOX0.s9J3RDQq8Og48lMar5cBpDyOgNBVh4Q2YsU6UQM7EP0",
          hand_off_with_javascript: () => {
            window.location.href = "./US_SFDC_demo/portal//";
          },
        };
      }
    </script>

    <!-- Only load the Intercom widget script when NOT using iframe mode -->
    <script>
      if (!USE_IFRAME_MODE) {
        (function () {
          var w = window; var ic = w.Intercom;
          if (typeof ic === "function") {
            ic("reattach_activator"); ic("update", w.intercomSettings);
          } else {
            var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); };
            w.Intercom = i; var l = function () {
              var s = d.createElement("script"); s.type = "text/javascript"; s.async = true;
              s.src = "https://widget.intercom.io/widget/nzmi3xql";
              var x = d.getElementsByTagName("script")[0]; x.parentNode.insertBefore(s, x);
            };
            if (document.readyState === "complete") { l(); }
            else if (w.attachEvent) { w.attachEvent("onload", l); }
            else { w.addEventListener("load", l, false); }
          }
        })();
      }
    </script>
  </body>
</html>
