<?php
// -------------------------------------------------------------
// Server-side: generate a JWT for Intercom Messenger
// -------------------------------------------------------------
// 1) Install once:  composer require firebase/php-jwt
// 2) Set your Messenger API Secret securely (env var recommended)
require __DIR__ . '/vendor/autoload.php';

use Firebase\JWT\JWT;

// Demo user values (replace with your real auth'd user data)
$userId   = $_GET['uid']   ?? '5068687910815';
$userName = $_GET['name']  ?? 'James Dunne';
$userEmail= $_GET['email'] ?? 'jd@zendeskdemo.com';

// NEVER hardcode secrets in production; use environment variables or a secrets manager
$apiSecret = getenv('INTERCOM_MESSENGER_API_SECRET') ?: '<YOUR_API_SECRET>'; // <-- replace or set env

// JWT payload: minimally include a stable user identifier. Email is optional but helpful.
$payload = [
  'user_id' => $userId,               // REQUIRED per Intercom JWT guide
  'email'   => $userEmail,            // Optional, but useful
  // Add any optional sensitive attributes you want available to Fin/Messenger:
  // 'plan' => 'enterprise',
  // 'role' => 'admin',
  'exp'     => time() + 3600          // Token expires in 1 hour
];

// Sign the token with HS256 using your Messenger API Secret
$token = JWT::encode($payload, $apiSecret, 'HS256');

// Small helper to safely echo into HTML/JS
function e($str) { return htmlspecialchars($str ?? '', ENT_QUOTES, 'UTF-8'); }
?>
<!doctype html>
<html>
  <head>
    <title>Fin ZD demo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      function reset() {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i];
          const eqPos = cookie.indexOf("=");
          const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
          document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        window.localStorage.clear();
        window.sessionStorage.clear();
        window.location.reload();
      }
    </script>
  </head>
  <body class="p-6 flex flex-col flex-1 items-center justify-center min-h-screen bg-cover"
        style="background-image: url('https://downloads.intercomcdn.com/i/o/1051523575/8c16c6bb97ae791131ead20c/blur.jpg')">
    <div class="flex flex-col space-y-2 items-center">
      <div>
        <img src="https://static.intercomassets.com/assets/default-avatars/fin/128-6a5eabbb84cc2b038b2afc6698ca0a974faf7adc9ea9f0fb3c3e78ac12543bc5.png"
             height="50" width="50" alt="Fin avatar">
      </div>
      <button class="bg-black text-white p-2 m-2 rounded hover:bg-opacity-75" onclick="reset()">Reset</button>
    </div>

    <script>
      // Intercom settings with JWT identity verification
      window.intercomSettings = {
        api_base: "https://api-iam.intercom.io",
        app_id: "z1n0atmw",                             // <-- keep or replace with your app id
        user_id: "<?= e($userId) ?>",                   // stable user id from your auth system
        name: "<?= e($userName) ?>",
        email: "<?= e($userEmail) ?>",
        jwt: "<?= e($token) ?>"                          // <--- JWT generated on the server
      };
    </script>

    <script>
      // We pre-filled your app ID in the widget URL: 'https://widget.intercom.io/widget/z1n0atmw'
      (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{
        var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;
        var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/z1n0atmw';
          var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};
        if(document.readyState==='complete'){l();}else if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}
      }})();
    </script>

    <!-- Start of d3v-mdlsolutions Zendesk Widget script -->
    <script id="ze-snippet" src="https://static.zdassets.com/ekr/snippet.js?key=64e085db-b7a2-4e29-911a-1987b55892bf"></script>
    <!-- End of d3v-mdlsolutions Zendesk Widget script -->
  </body>
</html>
